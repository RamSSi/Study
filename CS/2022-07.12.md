# 세마포어(Semaphore) & 뮤텍스(Mutex)

## 세마포어
멀티 프로그래밍 환경에서 공유 자원에 대한 접근을 제한하는 방법

- 임계 구역 : 여러 프로세스가 데이터를 공유하며 수행될 때, 각 프로세스에서 공유 데이터에 접근하는 프로그램 코드 부분.<br>
    - 한 프로세스가 임계 구역을 실행 중일 때에는 다른 프로세스가 접근할 수 없도록 제한해야 함

### 세마포어 P, V
- P : 임계 구역에 진입하기 전 수행하는 연산<br>
    - 프로세스 진입 여부를 자원 개수(S)를 통해 결정
- V : 임계 구역에서 나올 때 수행
    - 자원 반납 알림, 대기 중인 프로세스를 깨움

```
S = 1   // 자원 개수 = 접근 가능한 프로세스 수
procedure P(S) {
    while S = 0 // 이미 다른 프로세스가 데이터에 접근했기 때문에 기다림
        do wait
    S = S - 1   // 다른 프로세스의 접근을 막기 위해 S = 0으로 만들어 줌
}   
end P
{
    ... // 임계 구역
}
procedure V(S) {
    S = S + 1   // 임계 구역 코드 수행이 끝나면 S를 다시 1로 바꾸어 줌
}
end V
```

## 뮤텍스 (<strong>Mut</strong>ual <strong>Ex</strong>clusion)
임계 구역을 가진 스레드들의 실행시간이 겹치지 않도록 실행시키는 기술
- 해당 접근을 조율하기 위해 lock과 unlock을 사용
    - lock : 현재 임계 구역에 진입 가능한 권한을 얻어옴 (만약 다른 프로세스/스레드가 임계 구역에 진입한 상태이면 작업이 끝날 때까지 기다림)
    - unlock : 임계 구역 작업이 끝났음을 알림 (대기 중인 다른 프로세스/스레드가 임계 구역에 진입할 수 있음을 알림)
- 뮤텍스는 상태가 0, 1인 이진 세마포어이기도 함

### 뮤텍스 알고리즘
- 데커(Dekker) 알고리즘<br>
flag와 turn 변수를 통해 임계 구역에 들어갈 프로세스/스레드를 결정하는 방식
    - flag : 어떤 프로세스가 임계 영역에 진입할 것인지 나타내는 변수
    - turn : 임계 구역에 들어갈 차례를 나타내는 변수
```
flag[i] = true; // 프로세스 i가 임계 구역 접근 시도
while(flag[j]) {    // 임계 구역에 프로세스 j가 있을 때
    if (turn = j) { // 프로세스 j의 차례이면
        flag[i] = false;    // 접근 시도를 멈추고  
        while(turn = j);  // 프로세스 j의 turn이 끝날 때까지 기다림 
        flag[i] = true; // 재접근 시도
    }
}
{
    ...     // 임계 구역
}
turn = j;   // 프로세스 i의 임계 구역 작업이 끝나면 turn을 j로 바꾸어 주고
flag[i] = false;    // 임계 구역 사용 완료를 알림    
```
- 피터슨(Peterson) 알고리즘
    - 데커와 유사하지만 다른 프로세스에게 진입 기회를 양보하는 알고리즘
```
while(true) {
    flag[i] = true; //  프로세스 i가 임계 구역에 진입 시도
    turn = j;   // 먼저 접근을 원했던 프로세스 j에게 진입을 양보
    while(flag[j] && turn == j) // 프로세스 i의 차례가 될 때까지 기다림
}
{
    ... // 임계구역
}
flag[i] = false;    // 임계 구역 작업을 마쳤음을 알림
```